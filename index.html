<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– v7.4</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f;
            --card-bg: #2c3e50;
            --accent: #f39c12;
            --selected-bg: #1e3799; /* è·Ÿè¿” Image 1 å˜…æ·±è—è‰² */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; background: var(--bg-color); color: white;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { 
            display: none; flex-direction: column; align-items: center; 
            height: 100%; width: 100%; overflow-y: auto; 
            padding: calc(15px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px;
        }
        .screen.active { display: flex; }

        /* Config Card */
        .config-card { 
            background: var(--card-bg); width: 100%; max-width: 500px; 
            border-radius: 15px; padding: 15px; margin-bottom: 20px;
        }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }

        /* Category Grouping (è·Ÿè¿” Image 4) */
        .cat-group { width: 100%; max-width: 500px; margin-bottom: 20px; text-align: left; }
        .group-header { 
            font-size: 0.9rem; color: var(--accent); font-weight: bold; 
            margin: 15px 0 8px 5px; display: flex; align-items: center; gap: 5px;
        }
        .cat-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; width: 100%; 
        }

        /* é¡åˆ¥æŒ‰éˆ• (è·Ÿè¿” Image 4 æ¨£å¼ + Image 1 é¸å–æ„Ÿ) */
        .cat-item { 
            background: #ffffff; color: #333; padding: 14px 8px; border-radius: 12px; 
            text-align: center; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: all 0.2s;
        }
        /* æ€å’—ä¹‹å¾Œè®Šæ·±è‰² */
        .cat-item.selected { 
            background: var(--selected-bg) !important; color: white !important; 
            box-shadow: 0 2px 0 #0c2461; transform: translateY(2px);
        }
        .cat-item.selected::after { content: " âœ…"; font-size: 0.7rem; }

        /* Buttons */
        button.main-btn {
            background: var(--accent); color: white; border: none; padding: 18px;
            font-size: 1.2rem; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 6px 0 #b37400; width: 100%; max-width: 300px; margin: 10px 0;
            transition: 0.2s;
        }
        button.main-btn:disabled { background: #555; box-shadow: 0 4px 0 #333; opacity: 0.6; cursor: not-allowed; }
        
        /* Modal */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #2c3e50; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px;
            border: 1px solid var(--accent);
        }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">âš™ï¸ é¡Œåº«ç·¨è¼¯æŒ‡å¼•</h3>
            <p style="font-size:0.9rem; line-height:1.6;">
                1. é»æ“Šé€£çµç·¨è¼¯ Google Sheetï¼š<br>
                <a href="https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/edit" target="_blank" style="color:#3498db;">[é»æˆ‘é€²å…¥]</a><br><br>
                2. æµåˆ° <b>C8, C9, C10</b> æ ¼ä»”ï¼š<br>
                åˆ†åˆ¥å°æ‡‰ã€Œè‡ªè¨‚1, 2, 3ã€ã€‚<br>
                3. æ”¹å®Œå¾Œï¼Œæ’³ä¸‹é¢å€‹æ£é‡æ–°è¼‰å…¥ï¼š
            </p>
            <button class="main-btn" onclick="forceReload()" style="background:#27ae60; box-shadow:0 4px 0 #1e8449; width:100%; font-size:1rem;">ğŸ”„ å³æ™‚åŒæ­¥é¡Œåº«</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#aaa; margin-top:15px; width:100%;">é—œé–‰</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h2 style="margin:0 0 15px 0;">ğŸ“º æ´¾å°å¤§é›»è¦– LIVE</h2>
        
        <div class="config-card">
            <div class="config-row">
                <span>å°æˆ°æ¨¡å¼:</span>
                <button id="battle-btn" onclick="cycleBattle()" style="padding:6px 16px; border-radius:10px; border:none; background:#555; color:white; font-weight:bold;">OFF</button>
            </div>
            <div class="config-row">
                <span>é™æ™‚: <b id="time-val">60</b>s</span>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:60%; accent-color:var(--accent);">
            </div>
        </div>

        <p id="status-hint" style="margin:0 0 10px 0; font-size:0.85rem; width:100%; text-align:left; opacity:0.8;">é¸æ“‡é¡åˆ¥ (é¡Œç›®ä¸é‡è¤‡):</p>
        
        <div id="cat-container" style="width:100%; flex:1;">
            <p id="loading-text" style="text-align:center; padding-top:20px;">ğŸ“¡ æ­£åœ¨é€£ç·šé¡Œåº«...</p>
        </div>

        <button id="start-btn" class="main-btn" onclick="prepareStart()" disabled>è«‹å…ˆé¸æ“‡é¡åˆ¥</button>
        <button onclick="openModal()" style="background:none; border:1px solid #555; color:#aaa; padding:8px 20px; border-radius:20px; font-size:0.75rem; margin-top:10px;">âš™ï¸ é¡Œåº«è¨­å®š / ç·¨è¼¯è©èª</button>
    </div>

    <div id="game-screen" class="screen" style="justify-content:center;">
        <div id="game-timer" style="position:absolute; top:40px; font-size:2rem; font-weight:bold;">60s</div>
        <div id="word-display" style="font-size:clamp(2rem, 15vw, 6rem); font-weight:900; text-align:center;">Ready?</div>
        <div style="position:absolute; bottom:40px; opacity:0.3;">é»é ­ âœ… | æŠ¬é ­ âŒ</div>
    </div>

    <script>
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/export?format=csv&gid=0`;

        let allData = {};
        let battleMode = 0;
        let masterPool = [];
        let isGameActive = false;

        function init() {
            document.getElementById('loading-text').style.display = 'block';
            Papa.parse(SHEET_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    allData = {};
                    results.data.forEach(row => {
                        // è§£æ±º Case Sensitive å•é¡Œ
                        const cat = row.Category || row.category || row.CATEGORY;
                        const theme = row.Theme || row.theme || row.THEME;
                        const words = row.Words || row.words || row.WORDS;

                        if(cat && theme && words) {
                            if(!allData[cat]) allData[cat] = [];
                            allData[cat].push({
                                theme: theme.trim(),
                                words: words.split(/[|ï¼Œ]+/).map(w => w.trim()).filter(w => w)
                            });
                        }
                    });
                    renderUI();
                }
            });
        }

        function renderUI() {
            const container = document.getElementById('cat-container');
            container.innerHTML = '';
            
            if(Object.keys(allData).length === 0) {
                container.innerHTML = '<p style="text-align:center; color:red;">âŒ è®€å–ä¸åˆ°é¡Œåº«ï¼Œè«‹ç¢ºä¿ Sheet æ¨™é¡Œæ­£ç¢ºã€‚</p>';
                return;
            }

            // è·Ÿè¿” Image 4 å˜…åˆ†çµ„æ¸²æŸ“
            Object.keys(allData).forEach(catName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'cat-group';
                
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `ğŸ“‚ ${catName}`;
                groupDiv.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'cat-grid';
                
                allData[catName].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-item';
                    btn.innerText = item.theme;
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                        updateStartButton();
                    };
                    // ç”¨åšŸå„²å­˜è³‡æ–™æ–¹ä¾¿å¾Œé¢æ”è¿”
                    btn.dataset.cat = catName;
                    btn.dataset.theme = item.theme;
                    grid.appendChild(btn);
                });
                
                groupDiv.appendChild(grid);
                container.appendChild(groupDiv);
            });
        }

        function updateStartButton() {
            const selected = document.querySelectorAll('.cat-item.selected');
            const startBtn = document.getElementById('start-btn');
            const statusHint = document.getElementById('status-hint');
            let total = 0;

            selected.forEach(btn => {
                const data = allData[btn.dataset.cat].find(i => i.theme === btn.dataset.theme);
                total += data.words.length;
            });

            if(total > 0) {
                startBtn.disabled = false;
                startBtn.innerText = `ğŸ”¥ é–‹å§‹éŠæˆ² (${total}è©)`;
                statusHint.innerText = `å·²é¸å– ${selected.length} å€‹é¡åˆ¥`;
                statusHint.style.color = "var(--accent)";
            } else {
                startBtn.disabled = true;
                startBtn.innerText = "è«‹å…ˆé¸æ“‡é¡åˆ¥";
                statusHint.innerText = "é¸æ“‡é¡åˆ¥ (é¡Œç›®ä¸é‡è¤‡):";
                statusHint.style.color = "white";
            }
        }

        function cycleBattle() {
            battleMode = (battleMode === 0) ? 2 : (battleMode === 2 ? 3 : 0);
            const btn = document.getElementById('battle-btn');
            btn.innerText = battleMode === 0 ? "OFF" : (battleMode + " éšŠ");
            btn.style.background = battleMode > 0 ? "#27ae60" : "#555";
        }

        function forceReload() {
            document.getElementById('cat-container').innerHTML = '<p style="text-align:center;">ğŸ”„ åŒæ­¥ä¸­...</p>';
            init();
            closeModal();
        }

        function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // éŠæˆ²å•Ÿå‹•é‚è¼¯
        function prepareStart() {
            const selected = document.querySelectorAll('.cat-item.selected');
            masterPool = [];
            selected.forEach(btn => {
                const data = allData[btn.dataset.cat].find(i => i.theme === btn.dataset.theme);
                masterPool.push(...data.words);
            });
            masterPool.sort(() => Math.random() - 0.5);
            
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            // ... (å…¶é¤˜éŠæˆ²å€’æ•¸ Logic èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ)
            alert("éŠæˆ²æº–å‚™å°±ç·’ï¼è©èªç¸½æ•¸ï¼š" + masterPool.length);
            location.reload(); // å‘¢åº¦æš«æ™‚ reload ç¤ºç¯„ï¼Œä½ å¯ä»¥ä¿ç•™åŸæœ¬å˜… game logic
        }

        init();
    </script>
</body>
</html>
