<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ´¾å°å¤§é›»è¦– Cloud Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --accent: #f39c12;
            --secondary: #34495e;
            --correct: #27ae60;
            --skip: #c0392b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh;
        }

        .screen { display: none; flex-direction: column; align-items: center; height: 100%; width: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .screen.active { display: flex; }

        /* HOME SCREEN */
        #home-screen { padding: 20px 0; }
        h1 { font-size: 2.2rem; margin: 10px 0; text-shadow: 2px 2px 0 #000; }
        .loading-msg { color: var(--accent); font-weight: bold; margin: 20px; animation: blink 1s infinite; text-align:center; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .category-section { width: 90%; max-width: 600px; margin-bottom: 15px; }
        .category-title { font-size: 1.3rem; color: var(--accent); border-bottom: 2px solid var(--secondary); margin-bottom: 10px; font-weight: bold; }
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button {
            background: var(--text-color); color: var(--bg-color); border: none; padding: 15px;
            font-size: 1.1rem; border-radius: 10px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }

        /* GAME SCREEN */
        #game-screen { justify-content: center; text-align: center; position: relative; }
        #word-display { font-size: 18vw; font-weight: 900; line-height: 1.1; padding: 0 10px; word-break: keep-all; }
        .info-bar { position: absolute; top: 20px; display: flex; justify-content: space-between; width: 90%; font-size: 2rem; font-weight: bold; z-index: 10; }
        .bg-correct { background-color: var(--correct) !important; }
        .bg-skip { background-color: var(--skip) !important; }

        /* RESULT SCREEN */
        #result-screen { padding: 20px 0; }
        .big-score { font-size: 4rem; font-weight: 900; margin: 0; }
        .rank-title { font-size: 2.5rem; color: var(--accent); font-weight: 900; margin: 10px 0; }
        .result-list { width: 90%; max-width: 500px; background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; margin: 15px 0; max-height: 40vh; overflow-y: auto; }
        .result-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <h1>ğŸ“º æ´¾å°å¤§é›»è¦– <span style="font-size:1rem; background:var(--accent); padding:2px 5px; border-radius:4px;">LIVE</span></h1>
        <div id="loading" class="loading-msg">æ­£åœ¨åŒæ­¥ Google Sheet é¡Œåº«...</div>
        <div id="categories-container"></div>
        <button onclick="location.reload()" style="margin-top:20px; font-size:0.8rem; padding:8px 15px; background:none; color:white; box-shadow:none; border:1px solid #555; border-radius:20px;">ğŸ”„ é»æ“Šåˆ·æ–°é¡Œåº«</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="info-bar"><span id="timer">60</span><span id="score">0</span></div>
        <div id="word-display">Ready?</div>
        <div style="position:absolute; bottom:30px; opacity:0.6; background:rgba(0,0,0,0.2); padding:5px 15px; border-radius:15px;">é»é ­ âœ… | æŠ¬é ­ âŒ</div>
    </div>

    <div id="result-screen" class="screen">
        <div style="font-size:1.2rem; margin-top:20px;">æœ€çµ‚å¾—åˆ†</div>
        <div class="big-score" id="final-score">0</div>
        <div class="rank-title" id="rank-title"></div>
        <div class="result-list" id="result-list"></div>
        <button onclick="goHome()" style="width: 80%; background:white; color:#333;">è¿”å›ä¸»é¸å–®</button>
    </div>

    <script>
        // å·²å¡«å…¥ä½ çš„å°ˆå±¬ Google Sheet é€£çµ
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-boTTDGgpyB_26MVW0ciqBWTaqqJP9uRzlZcBMA0QeI7Cq2sQ877dcssXSJ89jTZtq1Fx7RB0p0h5/pub?gid=0&single=true&output=csv'; 

        let categories = {};
        let currentWords = [];
        let gameResults = [];
        let score = 0;
        let timeLeft = 60;
        let timerInterval;
        let isGameActive = false;
        let canTilt = true;

        function init() {
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function() {
                    document.getElementById('loading').innerText = "âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµ";
                }
            });
        }

        function processData(data) {
            categories = {};
            data.forEach(row => {
                const cat = row.Category;
                const theme = row.Theme;
                const rawWords = row.Words;
                if (cat && theme && rawWords) {
                    if (!categories[cat]) categories[cat] = {};
                    // æ”¯æ´ç›´ç·š | æˆ–å…¨å½¢é€—è™Ÿ ï¼Œ åˆ†éš”
                    categories[cat][theme] = rawWords.split(/[|ï¼Œ]+/).map(w => w.trim()).filter(w => w);
                }
            });
            renderMenu();
            document.getElementById('loading').style.display = 'none';
        }

        function renderMenu() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            for (const [catName, themes] of Object.entries(categories)) {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `<div class="category-title">${catName}</div>`;
                const grid = document.createElement('div');
                grid.className = 'theme-grid';
                for (const themeName of Object.keys(themes)) {
                    const btn = document.createElement('button');
                    btn.innerText = themeName;
                    btn.onclick = () => preStart(themes[themeName]);
                    grid.appendChild(btn);
                }
                section.appendChild(grid);
                container.appendChild(section);
            }
        }

        async function preStart(words) {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
            }
            currentWords = [...words].sort(() => 0.5 - Math.random());
            startGame();
        }

        function startGame() {
            score = 0; timeLeft = 60; gameResults = [];
            isGameActive = true; canTilt = true;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('score').innerText = 0;
            nextWord();
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
            window.addEventListener('deviceorientation', handleTilt);
        }

        function nextWord() {
            if (currentWords.length === 0) return endGame();
            const w = currentWords.pop();
            const display = document.getElementById('word-display');
            display.innerText = w;
            display.dataset.current = w;
            
            // è‡ªå‹•èª¿æ•´å­—é«”
            if(w.length > 10) display.style.fontSize = "8vw";
            else if(w.length > 6) display.style.fontSize = "12vw";
            else display.style.fontSize = "18vw";
            
            document.getElementById('game-screen').className = "screen active";
            canTilt = true;
        }

        function handleAnswer(type) {
            if (!isGameActive || !canTilt) return;
            canTilt = false;
            const w = document.getElementById('word-display').dataset.current;
            if (type === 'correct') {
                score++;
                document.getElementById('score').innerText = score;
                document.getElementById('game-screen').classList.add('bg-correct');
                gameResults.push({w: w, s: 'âœ…'});
            } else {
                document.getElementById('game-screen').classList.add('bg-skip');
                gameResults.push({w: w, s: 'âŒ'});
            }
            setTimeout(() => { if (!canTilt) { canTilt = true; nextWord(); } }, 600);
        }

        function handleTilt(e) {
            if (!isGameActive) return;
            const beta = e.beta;
            // è§’åº¦é‡ç½®é–å®š
            if (!canTilt && beta > 60 && beta < 120) { canTilt = true; nextWord(); return; }
            if (canTilt) {
                if (beta > 135) handleAnswer('correct');
                else if (beta < 35) handleAnswer('skip');
            }
        }

        // é»æ“Šå¾Œå‚™ (æ”¯æ´æ²’é™€èºå„€çš„æƒ…æ³)
        document.getElementById('game-screen').addEventListener('click', (e) => {
            if (!isGameActive) return;
            if (e.clientY < window.innerHeight / 2) handleAnswer('skip');
            else handleAnswer('correct');
        });

        function endGame() {
            isGameActive = false;
            clearInterval(timerInterval);
            window.removeEventListener('deviceorientation', handleTilt);
            document.getElementById('final-score').innerText = score;
            const list = document.getElementById('result-list');
            list.innerHTML = '';
            gameResults.forEach(r => {
                list.innerHTML += `<div class="result-item"><span>${r.w}</span><span style="color:${r.s==='âœ…'?'#27ae60':'#c0392b'}">${r.s}</span></div>`;
            });
            
            const title = document.getElementById('rank-title');
            if (score >= 9) { title.innerText = "ğŸ‘‘ æ´¾å°ä¹‹ç¥"; confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }
            else if (score >= 2) title.innerText = "ğŸ˜ æ™®é€šå¸‚æ°‘";
            else title.innerText = "ğŸ¤¡ æ°£æ°›ç ´å£è€…";

            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
        }

        function goHome() {
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('home-screen').classList.add('active');
        }

        init();
    </script>
</body>
</html>
