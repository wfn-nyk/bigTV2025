<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– Ultimate v7.1</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f; --text-color: #ecf0f1; --accent: #f39c12;
            --secondary: #34495e; --correct: #27ae60; --skip: #c0392b;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; background: var(--bg-color); color: var(--text-color);
            overflow: hidden; touch-action: none; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { 
            display: none; flex-direction: column; align-items: center; 
            height: 100%; width: 100%; overflow-y: auto; 
            padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px;
        }
        .screen.active { display: flex; }

        /* Pop-up Modal */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--secondary); padding: 25px; border-radius: 20px; width: 85%; max-width: 500px;
            max-height: 85vh; overflow-y: auto; position: relative; border: 1px solid #555;
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
        .highlight-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid var(--accent); }

        /* UI Elements */
        .config-card { background: var(--secondary); width: 100%; max-width: 600px; border-radius: 20px; padding: 15px; margin-bottom: 20px; }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; width: 100%; max-width: 600px; }
        .cat-item { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; text-align: center; }
        .cat-item.selected { border-color: var(--accent); background: rgba(243, 156, 18, 0.2); }
        
        #game-screen { justify-content: center; text-align: center; }
        #word-display { font-size: clamp(2rem, 15vw, 8rem); font-weight: 900; line-height: 1.2; padding: 20px; }
        .team-indicator { background: var(--accent); padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        .battle-score-board { display: flex; width: 100%; max-width: 600px; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .score-box { flex: 1; min-width: 100px; background: var(--secondary); padding: 10px; border-radius: 15px; text-align: center; border: 2px solid transparent; }
        .score-box.winner { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }

        button {
            background: var(--accent); color: white; border: none; padding: 15px;
            font-size: 1.1rem; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #b37400; width: 100%; max-width: 280px; margin: 5px;
        }
        .btn-outline { background: none; border: 1px solid #777; box-shadow: none; font-size: 0.9rem; margin-top: 10px; }
        .btn-reload { background: var(--correct); box-shadow: 0 4px 0 #1e8449; margin-top: 15px; }
        .toggle-btn { width: auto; font-size: 0.8rem; padding: 5px 12px; background: #555; box-shadow: none; }
        .toggle-btn.active { background: var(--correct); }
        .bg-correct { background-color: var(--correct) !important; }
        .bg-skip { background-color: var(--skip) !important; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <h3 style="margin-top:0;">âš™ï¸ é¡Œåº«æ•™å­¸èˆ‡è¨­å®š</h3>
            <p><strong>1. ç·¨è¼¯å°ˆå±¬é¡Œåº«ï¼š</strong><br>
            <a href="https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/edit?usp=sharing" target="_blank" style="color:var(--accent); word-break: break-all;">é»æ­¤æ‰“é–‹ Google è¡¨æ ¼é€²è¡Œç·¨è¼¯</a></p>
            
            <p><strong>2. å¦‚ä½•æ–°å¢è‡ªè¨‚é¡Œç›®ï¼š</strong></p>
            <div class="highlight-box">
                è«‹ç›´æ¥ä¿®æ”¹è¡¨æ ¼å…§çš„ <b>C8, C9, C10</b> æ ¼ä»”ï¼š<br>
                â€¢ <b>C8</b>ï¼šå°æ‡‰ã€Œè‡ªè¨‚æ¨¡å¼1ã€çš„è©èª<br>
                â€¢ <b>C9</b>ï¼šå°æ‡‰ã€Œè‡ªè¨‚æ¨¡å¼2ã€çš„è©èª<br>
                â€¢ <b>C10</b>ï¼šå°æ‡‰ã€Œè‡ªè¨‚æ¨¡å¼3ã€çš„è©èª
            </div>
            
            <p><strong>3. æ³¨æ„äº‹é …ï¼š</strong><br>
            - æ¯å€‹è©èªä¹‹é–“å¿…é ˆç”¨ <b>|</b> åˆ†éš”ã€‚<br>
            - ç©å®Œå¾Œè«‹è‡ªè¦ºåˆªé™¤è‡ªè¨‚å…§å®¹ï¼Œä»¥å…å½±éŸ¿ä»–äººã€‚<br>
            - <b>ä¿®æ”¹å®Œå¾Œï¼Œè«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•åŒæ­¥ï¼š</b></p>
            
            <button class="btn-reload" onclick="forceReload()">ğŸ”„ å³æ™‚åŒæ­¥é¡Œåº«</button>
            <button onclick="closeModal()" style="background:#777; box-shadow:0 4px 0 #555;">é—œé–‰</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h1 style="margin-bottom:10px;">ğŸ“º æ´¾å°å¤§é›»è¦–</h1>
        
        <div class="config-card">
            <div class="config-row">
                <label>å°æˆ°æ¨¡å¼:</label>
                <button id="battle-btn" class="toggle-btn" onclick="cycleBattle()">OFF</button>
            </div>
            <div class="config-row">
                <label>å®¹è¨±å‡ºè²:</label>
                <button id="sound-btn" class="toggle-btn active" onclick="toggleSound()">ON</button>
            </div>
            <div class="config-row">
                <label>é™æ™‚: <span id="time-val">60</span>s</label>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:60%; accent-color:var(--accent);">
            </div>
        </div>

        <div style="width:100%; max-width:600px; text-align:left; font-weight:bold; margin-bottom:5px;">é¸æ“‡é¡åˆ¥ (æ–¹æ¡ˆB: é¡Œç›®ä¸é‡è¦†):</div>
        <div id="cat-list" class="cat-grid"></div>
        <p id="count-hint" style="font-size:0.8rem; color:var(--accent); margin-top:10px;">è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡åˆ¥</p>

        <button id="start-btn" onclick="prepareStart()" style="margin-top:15px; opacity:0.5;">ğŸ”¥ é–‹å§‹éŠæˆ²</button>
        <button class="btn-outline" onclick="openModal()">âš™ï¸ é¡Œåº«è¨­å®š / ç·¨è¼¯è©èª</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="position:absolute; top:calc(15px + var(--safe-top)); width:92%; display:flex; justify-content:space-between; align-items:center;">
            <div id="current-team-label" class="team-indicator">éšŠä¼ 1</div>
            <div id="game-timer" style="font-size:1.5rem; font-weight:bold;">60s</div>
            <div id="game-score" style="font-size:1.5rem; font-weight:bold; color:var(--accent);">0</div>
        </div>
        <div id="word-display">Ready?</div>
        <div style="position:absolute; bottom:calc(30px + var(--safe-bottom)); opacity:0.5; font-size:0.8rem;">é»é ­ âœ… | æŠ¬é ­ âŒ</div>
        <button onclick="location.reload()" style="position:absolute; top:calc(15px + var(--safe-top)); right:10px; width:auto; padding:5px; background:none; box-shadow:none;">ğŸ </button>
    </div>

    <div id="result-screen" class="screen">
        <h2 id="result-header">æˆç¸¾å–®</h2>
        <div id="battle-summary" class="battle-score-board"></div>
        <div id="single-result-box" style="text-align:center;">
            <div id="final-score" style="font-size:4rem; font-weight:900;">0</div>
            <div id="rank-title" style="font-size:1.5rem; color:var(--accent); font-weight:bold; margin-bottom:15px;">-</div>
        </div>
        <div class="result-list" id="result-list" style="width:100%; max-width:600px; max-height:30vh; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:15px; margin-bottom:10px;"></div>
        <button id="next-team-btn" onclick="startNextRound()" style="display:none; margin-top:20px;">ä¸‹ä¸€éšŠé–‹å§‹</button>
        <button onclick="location.reload()" style="background:white; color:#333; margin-top:10px;">è¿”ä¸»é </button>
    </div>

    <script>
        // è‡ªå‹•è½‰æ›æˆ CSV å°å‡ºæ ¼å¼çš„é€£çµ
        const SHEET_ID = '1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

        let allData = {};
        let battleMode = 0; 
        let isSoundOn = true;
        let masterPool = []; 
        let gameResults = [];
        let teamScores = [0, 0, 0];
        let currentTeamIdx = 0;
        let isGameActive = false;
        let canTilt = true;
        let timerInterval;

        function init() {
            Papa.parse(SHEET_URL, {
                download: true, header: true,
                complete: (results) => {
                    allData = {};
                    results.data.forEach(row => {
                        if(row.Category && row.Theme && row.Words) {
                            const key = `${row.Category} - ${row.Theme}`;
                            allData[key] = row.Words.split(/[|ï¼Œ]+/).map(w => w.trim()).filter(w => w);
                        }
                    });
                    renderCats();
                    updateWordCount();
                }
            });
        }

        function forceReload() {
            init();
            closeModal();
            const btn = document.querySelector('.btn-reload');
            btn.innerText = "âœ… å·²å®ŒæˆåŒæ­¥";
            setTimeout(() => { btn.innerText = "ğŸ”„ å³æ™‚åŒæ­¥é¡Œåº«"; }, 2000);
        }

        function renderCats() {
            const container = document.getElementById('cat-list');
            const currentSelected = Array.from(document.querySelectorAll('.cat-item.selected')).map(el => el.dataset.key);
            container.innerHTML = '';
            Object.keys(allData).forEach(key => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                if(currentSelected.includes(key)) div.classList.add('selected');
                div.dataset.key = key;
                div.innerHTML = `<span>${key}</span>`;
                div.onclick = () => {
                    div.classList.toggle('selected');
                    updateWordCount();
                };
                container.appendChild(div);
            });
        }

        function updateWordCount() {
            const selected = Array.from(document.querySelectorAll('.cat-item.selected'));
            let total = 0;
            selected.forEach(div => {
                const key = div.dataset.key;
                if(allData[key]) total += allData[key].length;
            });
            const btn = document.getElementById('start-btn');
            const hint = document.getElementById('count-hint');
            
            const minRequired = battleMode > 0 ? 30 : 1;
            hint.innerText = `å·²é¸è©èª: ${total} ${battleMode > 0 ? '(å°æˆ°éœ€ 30 æ¢)' : ''}`;
            
            if(total >= minRequired) {
                btn.style.opacity = "1";
                btn.innerText = "ğŸ”¥ é–‹å§‹éŠæˆ²";
                hint.style.color = "#27ae60";
            } else {
                btn.style.opacity = "0.5";
                btn.innerText = battleMode > 0 ? "è©èªä¸è¶³ (éœ€30æ¢)" : "ğŸ”¥ é–‹å§‹éŠæˆ²";
                hint.style.color = "#f39c12";
            }
        }

        function cycleBattle() {
            battleMode = (battleMode === 0) ? 2 : (battleMode === 2 ? 3 : 0);
            const btn = document.getElementById('battle-btn');
            btn.innerText = battleMode === 0 ? "OFF" : (battleMode + " éšŠ");
            btn.classList.toggle('active', battleMode > 0);
            updateWordCount();
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-btn');
            btn.innerText = isSoundOn ? "ON" : "OFF";
            btn.classList.toggle('active', isSoundOn);
        }

        function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        async function prepareStart() {
            const selected = Array.from(document.querySelectorAll('.cat-item.selected'));
            let pool = [];
            selected.forEach(div => pool.push(...allData[div.dataset.key]));
            
            const minRequired = battleMode > 0 ? 30 : 1;
            if(pool.length < minRequired) return;

            masterPool = pool.sort(() => Math.random() - 0.5);
            teamScores = [0, 0, 0];
            currentTeamIdx = 0;

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (e) {}
            }
            startRound();
        }

        function startRound() {
            gameResults = [];
            isGameActive = true;
            canTilt = true;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            document.getElementById('current-team-label').innerText = `éšŠä¼ ${currentTeamIdx + 1}`;
            document.getElementById('game-score').innerText = "0";
            
            let timeLeft = parseInt(document.getElementById('time-val').innerText);
            document.getElementById('game-timer').innerText = timeLeft + "s";
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft + "s";
                if(timeLeft <= 0) endRound();
            }, 1000);

            nextWord();
            window.addEventListener('deviceorientation', handleTilt);
        }

        function nextWord() {
            if(masterPool.length === 0) return endRound();
            const word = masterPool.pop();
            const display = document.getElementById('word-display');
            display.innerText = word;
            display.dataset.current = word;
            display.style.fontSize = word.length > 8 ? "10vw" : "clamp(2rem, 15vw, 8rem)";
            document.getElementById('game-screen').className = "screen active";
            canTilt = true;
        }

        function handleAnswer(status) {
            if(!isGameActive || !canTilt) return;
            canTilt = false;
            const word = document.getElementById('word-display').dataset.current;
            gameResults.push({word: word, isCorrect: status === 'correct'});
            document.getElementById('game-screen').classList.add(status === 'correct' ? 'bg-correct' : 'bg-skip');
            document.getElementById('game-score').innerText = gameResults.filter(r => r.isCorrect).length;
            setTimeout(() => { if(isGameActive) {
                document.getElementById('game-screen').classList.remove('bg-correct', 'bg-skip');
                nextWord(); 
            }}, 600);
        }

        function handleTilt(e) {
            const beta = e.beta;
            if(!canTilt && beta > 60 && beta < 120) canTilt = true;
            if(canTilt && isGameActive) {
                if(beta > 135) handleAnswer('correct');
                else if(beta < 35) handleAnswer('skip');
            }
        }

        document.getElementById('game-screen').addEventListener('click', (e) => {
            if(!isGameActive) return;
            handleAnswer(e.clientY < window.innerHeight / 2 ? 'skip' : 'correct');
        });

        function endRound() {
            isGameActive = false;
            clearInterval(timerInterval);
            window.removeEventListener('deviceorientation', handleTilt);
            teamScores[currentTeamIdx] = gameResults.filter(r => r.isCorrect).length;
            showResults();
        }

        function showResults() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            
            const nextBtn = document.getElementById('next-team-btn');
            const summary = document.getElementById('battle-summary');
            const singleBox = document.getElementById('single-result-box');
            
            if(battleMode > 0 && currentTeamIdx < battleMode - 1) {
                document.getElementById('result-header').innerText = `éšŠä¼ ${currentTeamIdx + 1} å®Œæˆ`;
                nextBtn.style.display = "block";
                summary.style.display = "none";
                singleBox.style.display = "block";
                renderResultList();
                updateRank(teamScores[currentTeamIdx], gameResults.length);
            } else {
                document.getElementById('result-header').innerText = battleMode > 0 ? "å°æˆ°æœ€çµ‚çµæœ" : "éŠæˆ²çµæŸ";
                nextBtn.style.display = "none";
                if(battleMode > 0) {
                    summary.style.display = "flex";
                    singleBox.style.display = "none";
                    renderBattleSummary();
                } else {
                    summary.style.display = "none";
                    singleBox.style.display = "block";
                    updateRank(teamScores[0], gameResults.length);
                }
                renderResultList();
            }
        }

        function startNextRound() {
            currentTeamIdx++;
            startRound();
        }

        function renderBattleSummary() {
            const summary = document.getElementById('battle-summary');
            summary.innerHTML = '';
            const maxScore = Math.max(...teamScores.slice(0, battleMode));
            for(let i=0; i<battleMode; i++) {
                const box = document.createElement('div');
                box.className = "score-box" + (teamScores[i] === maxScore && maxScore > 0 ? " winner" : "");
                box.innerHTML = `éšŠä¼ ${i+1}<div style="font-size:2rem; font-weight:900;">${teamScores[i]}</div>`;
                summary.appendChild(box);
            }
            if(maxScore > 0 && currentTeamIdx === battleMode - 1) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        function renderResultList() {
            const list = document.getElementById('result-list');
            list.innerHTML = '';
            gameResults.forEach((res, idx) => {
                const row = document.createElement('div');
                row.style.display = "flex"; row.style.justifyContent = "space-between"; row.style.padding = "12px";
                row.style.borderBottom = "1px solid #444"; row.style.background = "rgba(255,255,255,0.05)";
                row.style.opacity = res.isCorrect ? "1" : "0.5";
                row.innerHTML = `<span>${res.word}</span><span>${res.isCorrect ? 'âœ…' : 'âŒ'}</span>`;
                row.onclick = () => {
                    res.isCorrect = !res.isCorrect;
                    teamScores[currentTeamIdx] = gameResults.filter(r => r.isCorrect).length;
                    document.getElementById('final-score').innerText = teamScores[currentTeamIdx];
                    if(battleMode > 0) renderBattleSummary();
                    else updateRank(teamScores[0], gameResults.length);
                    renderResultList();
                };
                list.appendChild(row);
            });
            document.getElementById('final-score').innerText = teamScores[currentTeamIdx];
        }

        function updateRank(score, total) {
            const pct = total > 0 ? (score / total) * 100 : 0;
            let title = "ğŸ¤¡ æ°£æ°›ç ´å£è€…";
            if(isSoundOn) {
                if(pct >= 85) title = "ğŸ‘‘ æ´¾å°ä¹‹ç¥";
                else if(pct >= 40) title = "ğŸ˜ æ™®é€šå¸‚æ°‘";
            } else {
                if(pct >= 70) title = "ğŸ‘‘ æ´¾å°ä¹‹ç¥";
                else if(pct >= 30) title = "ğŸ˜ æ™®é€šå¸‚æ°‘";
            }
            document.getElementById('rank-title').innerText = title;
            if(title.includes("ç¥") && !isGameActive) confetti({ particleCount: 50, spread: 60 });
        }

        init();
    </script>
</body>
</html>
