<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– v7.3</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f;
            --card-bg: #34495e;
            --accent: #f39c12;
            --selected-bg: #1e3799; /* æ€å’—ä¹‹å¾Œå˜…æ·±è—è‰²ï¼Œä¼¼ä½ å¼µåœ– */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; background: var(--bg-color); color: white;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { 
            display: none; flex-direction: column; align-items: center; 
            height: 100%; width: 100%; overflow-y: auto; 
            padding: calc(15px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px;
        }
        .screen.active { display: flex; }

        /* Config Card */
        .config-card { 
            background: var(--card-bg); width: 100%; max-width: 500px; 
            border-radius: 15px; padding: 15px; margin-bottom: 20px;
        }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }

        /* Category UI */
        .cat-section { width: 100%; max-width: 500px; margin-bottom: 20px; }
        .group-title { 
            color: var(--accent); font-size: 0.85rem; font-weight: bold; 
            margin: 15px 0 10px 0; text-align: left;
        }
        .cat-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px; width: 100%; 
        }
        .cat-item { 
            background: #ffffff; color: #333; padding: 12px 5px; border-radius: 10px; 
            text-align: center; font-weight: bold; font-size: 0.85rem; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: all 0.2s;
        }
        /* æ€å’—ä¹‹å¾Œå˜…æ·±è‰²æ•ˆæœ */
        .cat-item.selected { 
            background: var(--selected-bg); color: #fff; 
            box-shadow: 0 4px 0 #0c2461; transform: translateY(2px);
        }
        .cat-item.selected::after { content: " âœ…"; font-size: 0.7rem; }

        /* Main Buttons */
        button.main-btn {
            background: var(--accent); color: white; border: none; padding: 16px;
            font-size: 1.1rem; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 0 #b37400; width: 100%; max-width: 280px; margin: 8px 0;
        }
        button.main-btn:disabled { opacity: 0.3; box-shadow: none; transform: none; }
        
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #2c3e50; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px;
            text-align: left; border: 1px solid var(--accent);
        }
    </style>
</head>
<body>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="color:var(--accent); margin-top:0;">âš™ï¸ é¡Œåº«ç·¨è¼¯æŒ‡å¼•</h3>
            <p style="font-size:0.9rem; line-height:1.6;">
                1. é»æ“Šé€£çµé€²å…¥ Google Sheetï¼š<br>
                <a href="https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/edit" target="_blank" style="color:#3498db;">[æ‰“é–‹ Google Sheet]</a><br><br>
                2. æµåˆ° <b>C8, C9, C10</b> æ ¼ä»”åˆ†åˆ¥å°æ‡‰ã€Œè‡ªè¨‚1, 2, 3ã€ã€‚<br>
                3. è©èªä¹‹é–“è«‹ç”¨ <b>|</b> åˆ†éš”ã€‚<br><br>
                4. æ”¹å®Œå¾Œæ’³ä¸‹é¢å€‹æ£å³æ™‚æ›´æ–°ï¼š
            </p>
            <button class="main-btn" onclick="forceReload()" style="background:#27ae60; box-shadow:0 4px 0 #1e8449; font-size:1rem; width:100%;">ğŸ”„ å„²å­˜ä¸¦å³æ™‚åŒæ­¥</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h2 style="margin:0 0 15px 0;">ğŸ“º æ´¾å°å¤§é›»è¦– LIVE</h2>
        
        <div class="config-card">
            <div class="config-row">
                <span>å°æˆ°æ¨¡å¼:</span>
                <button id="battle-btn" onclick="cycleBattle()" style="padding:5px 15px; border-radius:8px; border:none; background:#555; color:white; font-weight:bold;">OFF</button>
            </div>
            <div class="config-row">
                <span>é™æ™‚: <b id="time-val">60</b>s</span>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:60%; accent-color:var(--accent);">
            </div>
        </div>

        <p style="margin:0 0 10px 0; font-size:0.85rem; width:100%; text-align:left; opacity:0.8;">é¸æ“‡é¡åˆ¥ (é¡Œç›®ä¸é‡è¤‡):</p>
        
        <div id="cat-container" style="width:100%; min-height:100px;">
            <p id="loading-text" style="text-align:center; opacity:0.5;">ğŸ“¡ æ­£åœ¨é€£ç·šé¡Œåº«...</p>
        </div>

        <button id="start-btn" class="main-btn" onclick="prepareStart()" disabled>è«‹å…ˆé¸æ“‡é¡åˆ¥</button>
        <button onclick="openModal()" style="background:none; border:1px solid #555; color:#aaa; padding:8px 20px; border-radius:20px; font-size:0.75rem; margin-top:10px;">âš™ï¸ é¡Œåº«è¨­å®š / è‡ªè¨‚è©èª</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; padding:10px;">
            <div id="current-team-label" style="background:var(--accent); padding:2px 10px; border-radius:10px; font-weight:bold;">éšŠä¼ 1</div>
            <div id="game-timer" style="font-size:1.2rem; font-weight:bold;">60s</div>
            <div id="game-score" style="font-size:1.2rem; font-weight:bold; color:var(--accent);">0</div>
        </div>
        <div style="flex:1; display:flex; align-items:center; justify-content:center;">
            <div id="word-display" style="font-size:clamp(2rem, 15vw, 6rem); font-weight:900; text-align:center; line-height:1.2;">Ready?</div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2 id="result-header">æˆç¸¾å–®</h2>
        <div id="battle-summary" style="display:flex; gap:10px; margin-bottom:20px; width:100%; justify-content:center;"></div>
        <div id="final-score" style="font-size:4rem; font-weight:900; text-align:center;">0</div>
        <div id="result-list" style="width:100%; max-width:500px; background:rgba(0,0,0,0.2); border-radius:15px; overflow-y:auto; flex:1; margin:15px 0;"></div>
        <button id="next-team-btn" class="main-btn" onclick="startNextRound()" style="display:none; background:#27ae60; box-shadow:0 5px 0 #1e8449;">ä¸‹ä¸€éšŠé–‹å§‹</button>
        <button onclick="location.reload()" class="main-btn" style="background:white; color:#333; box-shadow:0 5px 0 #bdc3c7;">è¿”ä¸»é </button>
    </div>

    <script>
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/export?format=csv&gid=0`;

        let allData = {};
        let battleMode = 0;
        let masterPool = [];
        let teamScores = [0, 0, 0];
        let currentTeamIdx = 0;
        let isGameActive = false;
        let timerInterval;

        // åˆå§‹åŒ–ï¼šè®€å–æ•¸æ“š
        function init() {
            document.getElementById('loading-text').style.display = 'block';
            Papa.parse(SHEET_URL, {
                download: true, 
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    allData = {};
                    console.log("CSV Data:", results.data); // Debug ç”¨
                    
                    results.data.forEach(row => {
                        // è‡ªå‹•ä¿®æ­£å¤§å°å¯«æ¨™é¡Œå•é¡Œ
                        const cat = row.Category || row.category || row.CATEGORY;
                        const theme = row.Theme || row.theme || row.THEME;
                        const words = row.Words || row.words || row.WORDS;

                        if(cat && theme && words) {
                            if(!allData[cat]) allData[cat] = [];
                            allData[cat].push({
                                theme: theme.trim(),
                                words: words.split(/[|ï¼Œ]+/).map(w => w.trim()).filter(w => w)
                            });
                        }
                    });
                    
                    if (Object.keys(allData).length === 0) {
                        document.getElementById('loading-text').innerText = "âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Sheet æ¨™é¡Œæ˜¯å¦ç‚º Category, Theme, Words";
                    } else {
                        renderUI();
                    }
                }
            });
        }

        function renderUI() {
            const container = document.getElementById('cat-container');
            container.innerHTML = '';
            
            Object.keys(allData).forEach(catName => {
                const section = document.createElement('div');
                section.className = 'cat-section';
                
                const title = document.createElement('div');
                title.className = 'group-title';
                title.innerText = `ğŸ“‚ ${catName}`;
                section.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = 'cat-grid';
                
                allData[catName].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-item';
                    btn.innerText = item.theme;
                    btn.dataset.cat = catName;
                    btn.dataset.theme = item.theme;
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                        updateState();
                    };
                    grid.appendChild(btn);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        function updateState() {
            const selected = document.querySelectorAll('.cat-item.selected');
            const startBtn = document.getElementById('start-btn');
            let total = 0;
            
            selected.forEach(btn => {
                const data = allData[btn.dataset.cat].find(i => i.theme === btn.dataset.theme);
                total += data.words.length;
            });

            const min = (battleMode > 0) ? 30 : 1;
            if(total >= min) {
                startBtn.disabled = false;
                startBtn.innerText = `ğŸ”¥ é–‹å§‹éŠæˆ² (${total}è©)`;
            } else {
                startBtn.disabled = true;
                startBtn.innerText = (battleMode > 0) ? `ä¸è¶³30è© (ç¾æœ‰${total})` : "è«‹å…ˆé¸æ“‡é¡åˆ¥";
            }
        }

        function cycleBattle() {
            battleMode = (battleMode === 0) ? 2 : (battleMode === 2 ? 3 : 0);
            const btn = document.getElementById('battle-btn');
            btn.innerText = battleMode === 0 ? "OFF" : (battleMode + " éšŠ");
            btn.style.background = battleMode > 0 ? "#27ae60" : "#555";
            updateState();
        }

        function forceReload() { 
            document.getElementById('cat-container').innerHTML = '<p style="text-align:center; opacity:0.5;">ğŸ“¡ æ­£åœ¨é‡æ–°åŒæ­¥...</p>';
            init(); 
            closeModal(); 
        }
        function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // éŠæˆ²æ ¸å¿ƒé‚è¼¯ (ç°¡åŒ–)
        async function prepareStart() {
            const selected = document.querySelectorAll('.cat-item.selected');
            masterPool = [];
            selected.forEach(btn => {
                const data = allData[btn.dataset.cat].find(i => i.theme === btn.dataset.theme);
                masterPool.push(...data.words);
            });
            masterPool.sort(() => Math.random() - 0.5);
            currentTeamIdx = 0;
            teamScores = [0, 0, 0];
            startRound();
        }

        function startRound() {
            gameResults = [];
            isGameActive = true;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            let timeLeft = parseInt(document.getElementById('time-val').innerText);
            document.getElementById('game-timer').innerText = timeLeft + "s";
            document.getElementById('current-team-label').innerText = `éšŠä¼ ${currentTeamIdx + 1}`;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft + "s";
                if(timeLeft <= 0) endRound();
            }, 1000);
            nextWord();
        }

        function nextWord() {
            if(masterPool.length === 0) return endRound();
            const word = masterPool.pop();
            const display = document.getElementById('word-display');
            display.innerText = word;
            display.dataset.current = word;
        }

        document.getElementById('game-screen').onclick = (e) => {
            if(!isGameActive) return;
            const isCorrect = e.clientY > window.innerHeight / 2;
            const word = document.getElementById('word-display').dataset.current;
            gameResults.push({word, isCorrect});
            document.getElementById('game-score').innerText = gameResults.filter(r => r.isCorrect).length;
            nextWord();
        };

        function endRound() {
            isGameActive = false;
            clearInterval(timerInterval);
            teamScores[currentTeamIdx] = gameResults.filter(r => r.isCorrect).length;
            showResults();
        }

        function showResults() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            const nextBtn = document.getElementById('next-team-btn');
            
            if(battleMode > 0 && currentTeamIdx < battleMode - 1) {
                nextBtn.style.display = "block";
            } else {
                nextBtn.style.display = "none";
                if(battleMode > 0) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
            document.getElementById('final-score').innerText = teamScores[currentTeamIdx];
            document.getElementById('result-list').innerHTML = gameResults.map(r => `<div style="padding:10px; border-bottom:1px solid #444; display:flex; justify-content:space-between;"><span>${r.word}</span><span>${r.isCorrect?'âœ…':'âŒ'}</span></div>`).join('');
        }

        function startNextRound() {
            currentTeamIdx++;
            startRound();
        }

        init();
    </script>
</body>
</html>
