<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– v7.5</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f;
            --card-bg: #2c3e50;
            --accent: #f39c12;
            --selected-bg: #2b30b4; /* æ·±è—ç´«è‰²ï¼Œè·Ÿè¿” Image 1 */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, sans-serif;
            margin: 0; background: var(--bg-color); color: white;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { 
            display: none; flex-direction: column; align-items: center; 
            height: 100%; width: 100%; overflow-y: auto; 
            padding: calc(15px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px;
        }
        .screen.active { display: flex; }

        /* Category Design */
        .cat-group { width: 100%; max-width: 500px; margin-bottom: 15px; text-align: left; }
        .group-header { font-size: 0.85rem; color: var(--accent); font-weight: bold; margin-bottom: 8px; opacity: 0.9; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        
        /* æ’³æ£æ¨£å¼ */
        .cat-item { 
            background: #ffffff; color: #333; padding: 12px 5px; border-radius: 12px; 
            text-align: center; font-weight: bold; font-size: 0.85rem; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: 0.1s;
        }
        /* æ€å’—ä¹‹å¾Œå˜…æ·±è‰²æ•ˆæœ */
        .cat-item.selected { 
            background: var(--selected-bg) !important; color: white !important; 
            box-shadow: 0 2px 0 #1a1e80; transform: translateY(2px);
        }
        .cat-item.selected::after { content: " âœ…"; font-size: 0.7rem; }

        /* Main Start Button */
        button.main-btn {
            background: var(--accent); color: white; border: none; padding: 18px;
            font-size: 1.1rem; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 6px 0 #b37400; width: 100%; max-width: 280px; margin: 15px 0;
        }
        button.main-btn:disabled { background: #444; box-shadow: 0 4px 0 #222; opacity: 0.5; }

        /* Loading Spinner */
        #loader { margin: 30px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="home-screen" class="screen active">
        <h2 style="margin:0 0 10px 0;">ğŸ“º æ´¾å°å¤§é›»è¦– LIVE</h2>
        
        <div style="background:var(--card-bg); width:100%; max-width:500px; border-radius:15px; padding:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>é™æ™‚: <b id="time-val">60</b>s</span>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:60%; accent-color:var(--accent);">
            </div>
        </div>

        <p style="margin:0 0 10px 0; font-size:0.8rem; width:100%; text-align:left; opacity:0.7;">è«‹é¸æ“‡ä¸»é¡Œ (å¯å¤šé¸):</p>
        
        <div id="loader"></div>
        <div id="cat-container" style="width:100%; flex:1;"></div>

        <button id="start-btn" class="main-btn" onclick="startGame()" disabled>è«‹å…ˆé¸æ“‡é¡åˆ¥</button>
        <p style="font-size:0.7rem; opacity:0.4;">v7.5 ç©©å®šç‰ˆ | è©èªå–è‡ª Column C</p>
    </div>

    <div id="game-screen" class="screen" style="justify-content:center;">
        <div id="timer-display" style="position:absolute; top:30px; font-size:2rem; font-weight:bold;">60s</div>
        <div id="word-display" style="font-size:clamp(2rem, 15vw, 6rem); font-weight:900; text-align:center;">Ready?</div>
    </div>

    <script>
        // ä½ çš„ Google Sheet CSV é€£çµ
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/export?format=csv&gid=0';

        let sheetData = {};
        let selectedPool = [];

        // 1. æŠ“å–è³‡æ–™ (æœ€ä½³åŒ–è®€å–)
        async function loadSheet() {
            try {
                const response = await fetch(CSV_URL, { cache: "no-cache" });
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processData(results.data);
                        document.getElementById('loader').style.display = 'none';
                    }
                });
            } catch (err) {
                alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
            }
        }

        // 2. è™•ç†è³‡æ–™ (è·Ÿè¿”ä½ å¼µ Sheet æ¨™é¡Œ: Category, Theme, Words)
        function processData(data) {
            sheetData = {};
            data.forEach(row => {
                const cat = row.Category || "å…¶ä»–";
                const theme = row.Theme || "æœªå‘½å";
                const wordsStr = row.Words || "";
                
                if (!sheetData[cat]) sheetData[cat] = [];
                // å°‡ Column C çš„è©èªæ‹†é–‹
                const wordList = wordsStr.split(/[|ï¼Œ,]+/).map(w => w.trim()).filter(w => w.length > 0);
                
                sheetData[cat].push({ theme, wordList });
            });
            renderCategories();
        }

        // 3. æ¸²æŸ“ UI (åˆ†çµ„ Tab)
        function renderCategories() {
            const container = document.getElementById('cat-container');
            container.innerHTML = '';

            Object.keys(sheetData).forEach(catName => {
                const group = document.createElement('div');
                group.className = 'cat-group';
                group.innerHTML = `<div class="group-header">${catName}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'cat-grid';

                sheetData[catName].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-item';
                    btn.innerText = item.theme;
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                        updateStartButton();
                    };
                    btn.dataset.words = JSON.stringify(item.wordList);
                    grid.appendChild(btn);
                });

                group.appendChild(grid);
                container.appendChild(group);
            });
        }

        // 4. æ›´æ–°é–‹å§‹æŒ‰éˆ•ç‹€æ…‹
        function updateStartButton() {
            const selectedItems = document.querySelectorAll('.cat-item.selected');
            const startBtn = document.getElementById('start-btn');
            
            let totalWords = 0;
            selectedPool = [];
            
            selectedItems.forEach(item => {
                const words = JSON.parse(item.dataset.words);
                selectedPool.push(...words);
                totalWords += words.length;
            });

            if (totalWords > 0) {
                startBtn.disabled = false;
                startBtn.innerText = `ğŸ”¥ é–‹å§‹ (${totalWords} è©)`;
            } else {
                startBtn.disabled = true;
                startBtn.innerText = "è«‹å…ˆé¸æ“‡é¡åˆ¥";
            }
        }

        // 5. éŠæˆ²å•Ÿå‹• (ç°¡åŒ–ç‰ˆ)
        function startGame() {
            if (selectedPool.length === 0) return;
            
            // æ´—ç‰Œ
            selectedPool.sort(() => Math.random() - 0.5);
            
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            let timeLeft = parseInt(document.getElementById('time-val').innerText);
            runGame(timeLeft);
        }

        function runGame(seconds) {
            const timerDiv = document.getElementById('timer-display');
            const wordDiv = document.getElementById('word-display');
            
            let currentIdx = 0;
            wordDiv.innerText = selectedPool[currentIdx];

            const timer = setInterval(() => {
                seconds--;
                timerDiv.innerText = seconds + "s";
                if (seconds <= 0) {
                    clearInterval(timer);
                    alert("æ™‚é–“åˆ°ï¼éŠæˆ²çµæŸ");
                    location.reload();
                }
            }, 1000);

            // é»æ“Šç•«é¢æ›ä¸‹ä¸€é¡Œ (ç°¡å–®æ¨¡æ“¬)
            document.getElementById('game-screen').onclick = () => {
                currentIdx++;
                if (currentIdx < selectedPool.length) {
                    wordDiv.innerText = selectedPool[currentIdx];
                } else {
                    alert("å®Œå’—é¡Œåº«å•¦ï¼");
                    location.reload();
                }
            };
        }

        // å•Ÿå‹•
        loadSheet();
    </script>
</body>
</html>
