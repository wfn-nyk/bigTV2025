<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– v8.0</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f; --card-bg: #2c3e50; --accent: #f39c12;
            --success: #27ae60; --fail: #c0392b; --selected-bg: #1e3799; 
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0; background: var(--bg-color); color: white;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { display: none; flex-direction: column; align-items: center; height: 100%; width: 100%; overflow-y: auto; padding: calc(15px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px; }
        .screen.active { display: flex; }

        /* --- UI: è¨­å®šèˆ‡å¡ç‰‡ --- */
        .config-card { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 15px; padding: 12px; margin-bottom: 12px; }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
        
        /* åˆ†é¡é¡¯ç¤ºæ¨£å¼ (æ¢å¾© v7.5 é¢¨æ ¼) */
        .cat-group { width: 100%; max-width: 500px; margin-bottom: 20px; text-align: left; }
        .group-header { 
            font-size: 1rem; color: var(--accent); font-weight: bold; margin: 0 0 8px 5px; 
            display: flex; align-items: center;
        }
        .group-header::before { content: 'ğŸ“‚ '; margin-right: 5px; font-size: 1.1rem; }
        
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        
        .cat-item { 
            background: #ffffff; color: #333; padding: 15px 5px; border-radius: 12px; 
            text-align: center; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: transform 0.1s, background 0.2s;
        }
        .cat-item:active { transform: translateY(4px); box-shadow: none; }
        .cat-item.selected { 
            background: var(--selected-bg) !important; color: white !important; 
            box-shadow: 0 4px 0 #0c2461; transform: translateY(2px);
        }
        .cat-item.selected::after { content: " âœ…"; font-size: 0.8rem; }

        /* --- UI: çµæœèˆ‡æŒ‰éˆ• --- */
        #rank-title { font-size: 1.5rem; color: var(--accent); font-weight: bold; margin-bottom: 5px; letter-spacing: 2px; }
        .result-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        
        button.main-btn { background: var(--accent); color: white; border: none; padding: 16px; font-size: 1.1rem; border-radius: 50px; font-weight: bold; box-shadow: 0 6px 0 #b37400; width: 100%; max-width: 300px; margin-top: 10px; }
        button.main-btn:disabled { opacity: 0.4; box-shadow: none; background: #7f8c8d; cursor: not-allowed; }
        .toggle-btn { background: #555; border: none; color: white; padding: 4px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- Loader --- */
        #loader-box { margin-top: 20px; text-align: center; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Modal --- */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #2c3e50; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; border: 2px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="color:var(--accent); margin-top:0;">âš™ï¸ é¡Œåº«ç·¨è¼¯æŒ‡å¼•</h3>
            <p style="font-size:0.9rem; line-height:1.6; color:#ecf0f1;">
                1. ç·¨è¼¯ Google Sheet è©èªï¼š<br>
                <a href="https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/edit" target="_blank" style="color:#3498db; font-weight:bold;">[é–‹å•Ÿ Google Sheet]</a><br>
                2. è©èªå­˜æ”¾åœ¨ Column C (ä»¥ | åˆ†éš”)ã€‚<br>
                3. æ”¹å®Œå¾Œï¼Œæ’³ä¸‹é¢å€‹æ£å³æ™‚åŒæ­¥ï¼š
            </p>
            <button class="main-btn" onclick="forceSync()" style="background:var(--success); box-shadow:0 4px 0 #1e8449; width:100%;">ğŸ”„ å³æ™‚åŒæ­¥é¡Œåº«è³‡æ–™</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#aaa; width:100%; margin-top:15px;">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h2 style="margin:0 0 10px 0;">ğŸ“º æ´¾å°å¤§é›»è¦– v8.0</h2>
        
        <div class="config-card">
            <div class="config-row">
                <span>å°æˆ°æ¨¡å¼:</span>
                <button id="battle-btn" class="toggle-btn" onclick="cycleBattle()">OFF</button>
            </div>
            <div class="config-row">
                <span>éŠæˆ²éŸ³æ•ˆ:</span>
                <button id="sound-btn" class="toggle-btn" onclick="toggleSound()">ON</button>
            </div>
            <div class="config-row">
                <span>é™æ™‚: <b id="time-val">60</b>s</span>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:50%; accent-color:var(--accent);">
            </div>
        </div>

        <p style="margin:0 0 10px 0; font-size:0.85rem; width:100%; text-align:left; opacity:0.8;">è«‹é¸æ“‡é¡åˆ¥ (æ”¯æŒå¤šé¸):</p>
        
        <div id="loader-box">
            <div class="spinner"></div>
            <div style="font-size:0.8rem; opacity:0.7;">æ­£åœ¨è®€å–é¡Œåº«...</div>
        </div>
        
        <div id="cat-container" style="width:100%; flex:1;"></div>

        <button id="start-btn" class="main-btn" onclick="requestPermission()" disabled>è«‹å…ˆé¸æ“‡é¡åˆ¥</button>
        <button onclick="openModal()" style="background:none; border:1px solid #555; color:#aaa; padding:8px 20px; border-radius:20px; font-size:0.7rem; margin:15px 0 5px 0;">âš™ï¸ ç·¨è¼¯è©èª / è¨­å®š</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <button onclick="exitGame()" style="font-size:1.5rem; background:none; border:none; color:white;">âŒ</button>
            <div id="team-label" style="background:var(--accent); padding:4px 15px; border-radius:15px; font-weight:bold; display:none;">éšŠä¼ 1</div>
            <div id="game-timer" style="font-size:1.6rem; font-weight:bold; font-variant-numeric: tabular-nums;">60s</div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%;">
            <div id="word-cat-hint" style="color:var(--accent); font-weight:bold; margin-bottom:15px; font-size:1.2rem; opacity:0.9;"></div>
            <div id="word-display" style="font-size:clamp(3rem, 15vw, 6rem); font-weight:900; text-align:center; line-height:1.2; text-shadow:0 5px 15px rgba(0,0,0,0.5);">READY</div>
        </div>
        <div style="width:100%; display:flex; gap:15px; padding-bottom:10px;">
            <button onclick="handleAnswer(false)" style="flex:1; padding:20px; border-radius:15px; border:none; background:var(--fail); color:white; font-weight:bold; font-size:1.2rem; box-shadow:0 5px 0 #922b21;">PASS</button>
            <button onclick="handleAnswer(true)" style="flex:1; padding:20px; border-radius:15px; border:none; background:var(--success); color:white; font-weight:bold; font-size:1.2rem; box-shadow:0 5px 0 #1e8449;">æ­£ç¢º</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div id="rank-title">ç¨±è™Ÿè¨ˆç®—ä¸­...</div>
        <div id="final-score" style="font-size:5rem; font-weight:900; color:var(--accent); line-height:1; margin:10px 0;">0</div>
        <div style="margin:0 0 15px 0; font-size:0.8rem; opacity:0.6;">(é»æ“Šé¡Œç›®å¯æ‰‹å‹•æ”¹åˆ†)</div>
        <div id="result-list-container" style="width:100%; max-width:500px; background:rgba(0,0,0,0.2); border-radius:15px; flex:1; overflow-y:auto; padding:5px;"></div>
        <button id="next-team-btn" class="main-btn" onclick="nextRound()" style="display:none; background:var(--success);">ä¸‹ä¸€éšŠé–‹å§‹</button>
        <button onclick="resetGame()" class="main-btn" style="background:white; color:#333; box-shadow:0 6px 0 #bdc3c7;">è¿”å›ä¸»é </button>
    </div>

    <script>
        // ä½¿ç”¨ä½ æä¾›çš„æ­£ç¢º Google Sheet CSV é€£çµ
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/export?format=csv&gid=0';
        
        let allData = {};
        let battleMode = 0;
        let isSoundOn = true;
        let currentTeamIdx = 0;
        let teamScores = [0, 0, 0];
        let gamePool = [];
        let currentWordIdx = 0;
        let gameResults = [];
        let timer = null;
        let isGameActive = false;
        let lastActionTime = 0;

        // --- æ ¸å¿ƒä¿®å¾©ï¼šæ›´å¼·çš„æ•¸æ“šè®€å–é‚è¼¯ ---
        async function loadData() {
            document.getElementById('loader-box').style.display = 'block';
            document.getElementById('cat-container').innerHTML = '';
            
            try {
                const res = await fetch(CSV_URL + '&t=' + Date.now());
                const text = await res.text();
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (h) => h.trim(), // é—œéµä¿®å¾©ï¼šè‡ªå‹•æ¸…é™¤ Header çš„ç©ºæ ¼
                    complete: (results) => {
                        allData = {};
                        let count = 0;
                        
                        results.data.forEach(row => {
                            // å®¹éŒ¯è®€å–ï¼šå¦‚æœ Category æ˜¯ undefinedï¼Œå˜—è©¦ç”¨ keys[0]
                            const cat = row.Category || row[Object.keys(row)[0]] || "å…¶ä»–";
                            const theme = row.Theme || row[Object.keys(row)[1]] || "ä¸»é¡Œ";
                            let wordsRaw = row.Words || row[Object.keys(row)[2]];
                            
                            if (wordsRaw) {
                                const words = wordsRaw.split(/[|ï¼Œ,]+/).map(s=>s.trim()).filter(s=>s);
                                if (words.length > 0) {
                                    if(!allData[cat]) allData[cat] = [];
                                    allData[cat].push({ theme, words });
                                    count++;
                                }
                            }
                        });

                        document.getElementById('loader-box').style.display = 'none';
                        if (count === 0) {
                            document.getElementById('cat-container').innerHTML = '<div style="text-align:center; margin-top:20px; color:#e74c3c;">âš ï¸ æ‰¾ä¸åˆ°é¡Œç›®<br>è«‹æª¢æŸ¥ Google Sheet æ ¼å¼ (Col A, B, C)</div>';
                        } else {
                            renderUI();
                        }
                    }
                });
            } catch (e) { 
                document.getElementById('loader-box').innerHTML = '<span style="color:red">ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹åˆ·æ–°é‡è©¦</span>';
            }
        }

        function renderUI() {
            const container = document.getElementById('cat-container');
            container.innerHTML = '';
            
            Object.keys(allData).forEach(cat => {
                const group = document.createElement('div');
                group.className = 'cat-group';
                
                // æ¨™é¡Œæ¨£å¼ (ä¿®å¾©é¡¯ç¤ºå•é¡Œ)
                group.innerHTML = `<div class="group-header">${cat}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'cat-grid';
                
                allData[cat].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-item';
                    btn.innerText = item.theme;
                    // ä¿å­˜æ•¸æ“šåˆ°å…ƒç´ ä»¥ä¾¿è®€å–
                    btn.dataset.theme = item.theme;
                    btn.dataset.cat = cat;
                    
                    btn.onclick = () => { 
                        btn.classList.toggle('selected'); 
                        updateStartBtn(); 
                    };
                    grid.appendChild(btn);
                });
                group.appendChild(grid);
                container.appendChild(group);
            });
        }

        function updateStartBtn() {
            const selected = document.querySelectorAll('.cat-item.selected');
            let total = 0;
            selected.forEach(el => {
                const catData = allData[el.dataset.cat];
                if(catData) {
                    const item = catData.find(i => i.theme === el.dataset.theme);
                    if(item) total += item.words.length;
                }
            });
            const btn = document.getElementById('start-btn');
            btn.disabled = total === 0;
            btn.innerText = total > 0 ? `ğŸ”¥ é–‹å§‹ (${total}è©)` : "è«‹å…ˆé¸æ“‡é¡åˆ¥";
            // æŒ‰éˆ•è®Šè‰²æé†’
            btn.style.background = total > 0 ? "var(--accent)" : "#7f8c8d";
        }

        // --- å½ˆçª—èˆ‡è¨­å®š ---
        function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function forceSync() { loadData(); closeModal(); }
        
        function cycleBattle() {
            battleMode = (battleMode === 0) ? 2 : (battleMode === 2 ? 3 : 0);
            const btn = document.getElementById('battle-btn');
            btn.innerText = battleMode === 0 ? "OFF" : (battleMode + " éšŠ");
            btn.style.background = battleMode > 0 ? "var(--success)" : "#555";
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            document.getElementById('sound-btn').innerText = isSoundOn ? "ON" : "OFF";
            document.getElementById('sound-btn').style.background = isSoundOn ? "var(--success)" : "#555";
        }

        // --- éŠæˆ²æµç¨‹ ---
        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(res => { if(res==='granted') setupGame(); });
            } else { setupGame(); }
        }

        function setupGame() {
            const selected = document.querySelectorAll('.cat-item.selected');
            gamePool = [];
            selected.forEach(el => {
                const item = allData[el.dataset.cat].find(i => i.theme === el.dataset.theme);
                item.words.forEach(w => gamePool.push({ word: w, theme: item.theme }));
            });
            gamePool.sort(() => Math.random() - 0.5);
            currentTeamIdx = 0;
            teamScores = [0, 0, 0];
            startRound();
        }

        function startRound() {
            gameResults = []; currentWordIdx = 0; isGameActive = true;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            const tl = document.getElementById('team-label');
            if(battleMode > 0) {
                tl.style.display = 'block'; tl.innerText = `éšŠä¼ ${currentTeamIdx + 1}`;
                tl.style.backgroundColor = ['#e74c3c', '#3498db', '#f1c40f'][currentTeamIdx];
            } else { tl.style.display = 'none'; }

            let timeLeft = parseInt(document.getElementById('time-val').innerText);
            document.getElementById('game-timer').innerText = timeLeft + "s";
            
            if(timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft + "s";
                if(timeLeft <= 0) finishRound();
            }, 1000);

            window.addEventListener('deviceorientation', handleMotion);
            nextWord();
        }

        function nextWord() {
            if(currentWordIdx >= gamePool.length) { finishRound(); return; }
            const data = gamePool[currentWordIdx];
            document.getElementById('word-display').innerText = data.word;
            document.getElementById('word-cat-hint').innerText = data.theme;
        }

        function handleMotion(e) {
            if(!isGameActive || Date.now() - lastActionTime < 1000) return;
            // é«”æ„Ÿé‚è¼¯: é»é ­(Beta > 60)æ­£ç¢º, æŠ¬é ­(Beta < -30) Pass
            if(e.beta > 60) handleAnswer(true);
            else if(e.beta < -30) handleAnswer(false);
        }

        function handleAnswer(correct) {
            if(!isGameActive) return;
            lastActionTime = Date.now();
            gameResults.push({ word: gamePool[currentWordIdx].word, correct });
            
            const display = document.getElementById('word-display');
            display.style.color = correct ? 'var(--success)' : 'var(--fail)';
            
            setTimeout(() => {
                display.style.color = 'white';
                currentWordIdx++; nextWord();
            }, 200);
        }

        function finishRound() {
            isGameActive = false;
            clearInterval(timer);
            window.removeEventListener('deviceorientation', handleMotion);
            
            const score = gameResults.filter(r => r.correct).length;
            teamScores[currentTeamIdx] = score;
            showResults(score);
        }

        function showResults(score) {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            document.getElementById('final-score').innerText = score;
            
            // ç¨±è™Ÿåˆ¤å®š
            const pct = gameResults.length > 0 ? (score / gameResults.length) * 100 : 0;
            let title = "æ°£æ°›ç ´å£è€… ğŸ¥¶";
            if (isSoundOn) { // é–‹è²: è¦æ±‚è¼ƒé«˜
                if (pct >= 85) title = "æ´¾å°ä¹‹ç¥ ğŸ‘‘";
                else if (pct >= 40) title = "æ™®é€šå¸‚æ°‘ ğŸ˜";
            } else { // éœéŸ³: è¦æ±‚è¼ƒä½
                if (pct >= 70) title = "æ´¾å°ä¹‹ç¥ ğŸ‘‘";
                else if (pct >= 30) title = "æ™®é€šå¸‚æ°‘ ğŸ˜";
            }
            document.getElementById('rank-title').innerText = title;
            if (title.includes("ç¥")) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            renderResultList();
            
            const nextBtn = document.getElementById('next-team-btn');
            if(battleMode > 0 && currentTeamIdx < battleMode - 1) {
                nextBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        function renderResultList() {
            const container = document.getElementById('result-list-container');
            container.innerHTML = gameResults.map((r, i) => `
                <div class="result-item" onclick="toggleResult(${i})">
                    <span>${r.word}</span>
                    <span style="color:${r.correct?'var(--success)':'var(--fail)'}; font-weight:bold;">
                        ${r.correct?'âœ… æ­£ç¢º':'Pass'}
                    </span>
                </div>
            `).join('');
        }

        function toggleResult(idx) {
            gameResults[idx].correct = !gameResults[idx].correct;
            const newScore = gameResults.filter(r => r.correct).length;
            teamScores[currentTeamIdx] = newScore;
            document.getElementById('final-score').innerText = newScore;
            // é‡æ–°è¨ˆç®—ç¨±è™Ÿ (å¯é¸)
            renderResultList();
        }

        function nextRound() { currentTeamIdx++; startRound(); }
        function exitGame() { if(confirm("ç¢ºå®šçµæŸéŠæˆ²ï¼Ÿ")) location.reload(); }
        function resetGame() { location.reload(); }

        // å•Ÿå‹•è®€å–
        loadData();
    </script>
</body>
</html>
