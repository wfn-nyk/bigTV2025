<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ´¾å°å¤§é›»è¦– v9.0</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #1a252f; --card-bg: #2c3e50; --accent: #f39c12;
            --success: #27ae60; --fail: #c0392b; --selected-bg: #1e3799; 
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0; background: var(--bg-color); color: white;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }
        .screen { display: none; flex-direction: column; align-items: center; height: 100%; width: 100%; overflow-y: auto; padding: calc(15px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px; }
        .screen.active { display: flex; }

        /* --- è¦–è¦ºç‰¹æ•ˆ Overlay --- */
        #feedback-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; display: flex; justify-content: center; align-items: center;
            font-size: 10rem; font-weight: 900; opacity: 0; transition: opacity 0.2s;
        }
        .flash-green { animation: anim-green 0.6s forwards; }
        .flash-red { animation: anim-red 0.6s forwards; }

        @keyframes anim-green {
            0% { background: rgba(39, 174, 96, 0); opacity: 1; transform: scale(0.8); content: "âœ…"; }
            20% { background: rgba(39, 174, 96, 0.8); transform: scale(1.2); }
            100% { background: rgba(39, 174, 96, 0); opacity: 0; transform: scale(1.5); }
        }
        @keyframes anim-red {
            0% { background: rgba(192, 57, 43, 0); opacity: 1; transform: scale(0.8); content: "âŒ"; }
            20% { background: rgba(192, 57, 43, 0.8); transform: scale(1.2); }
            100% { background: rgba(192, 57, 43, 0); opacity: 0; transform: scale(1.5); }
        }

        /* --- UI Components --- */
        .config-card { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 15px; padding: 12px; margin-bottom: 12px; }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
        .toggle-btn { background: #555; border: none; color: white; padding: 6px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .cat-group { width: 100%; max-width: 500px; margin-bottom: 20px; text-align: left; }
        .group-header { font-size: 1rem; color: var(--accent); font-weight: bold; margin: 0 0 8px 5px; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .cat-item { 
            background: #ffffff; color: #333; padding: 15px 5px; border-radius: 12px; 
            text-align: center; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 4px 0 #bdc3c7; transition: transform 0.1s;
        }
        .cat-item.selected { background: var(--selected-bg) !important; color: white !important; box-shadow: 0 4px 0 #0c2461; transform: translateY(2px); }
        
        button.main-btn { background: var(--accent); color: white; border: none; padding: 16px; font-size: 1.2rem; border-radius: 50px; font-weight: bold; box-shadow: 0 6px 0 #b37400; width: 100%; max-width: 300px; margin-top: 10px; }
        button.main-btn:disabled { opacity: 0.4; box-shadow: none; background: #7f8c8d; }

        /* Game Screen */
        #word-display { font-size: clamp(3rem, 15vw, 6.5rem); font-weight: 900; text-align: center; line-height: 1.1; text-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; }
        .hint-bar { margin-top:15px; font-size: 0.8rem; opacity: 0.6; display: flex; gap: 20px; }
        
        /* Modal */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #2c3e50; padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; border: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div id="feedback-overlay"></div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>âš™ï¸ ç·¨è¼¯èˆ‡è‡ªè¨‚</h3>
            <p style="font-size:0.9rem; color:#ecf0f1;">
                1. <a href="https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/edit" target="_blank" style="color:#3498db;">æ‰“é–‹ Google Sheet</a><br>
                2. <b>è‡ªè¨‚é¡Œç›®</b> è«‹å¡«å¯«åœ¨ "è‡ªè¨‚" é¡åˆ¥ï¼Œæˆ–ç›´æ¥æ”¹ Sheet å…§å®¹ã€‚<br>
            </p>
            <button class="main-btn" onclick="forceSync()" style="background:var(--success); width:100%;">ğŸ”„ å³æ™‚åŒæ­¥</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#aaa; width:100%; margin-top:15px;">é—œé–‰</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <h2 style="margin:0 0 10px 0;">ğŸ“º æ´¾å°å¤§é›»è¦– v9.0</h2>
        
        <div class="config-card">
            <div class="config-row">
                <span>å°æˆ°æ¨¡å¼:</span>
                <button id="battle-btn" class="toggle-btn" onclick="cycleBattle()">OFF</button>
            </div>
            <div class="config-row">
                <span>éŠæˆ²éŸ³æ•ˆ:</span>
                <button id="sound-btn" class="toggle-btn" onclick="toggleSound()">ON</button>
            </div>
            <div class="config-row">
                <span>é™æ™‚: <b id="time-val">60</b>s</span>
                <input type="range" min="30" max="180" step="10" value="60" oninput="document.getElementById('time-val').innerText=this.value" style="width:50%; accent-color:var(--accent);">
            </div>
        </div>

        <p style="margin:0 0 10px 0; font-size:0.85rem; opacity:0.8;">è«‹é¸æ“‡é¡åˆ¥ (è‡ªè¨‚é¡Œç›®å·²ä¿®å¾©):</p>
        
        <div id="loader-box" style="margin:20px 0;">
            <div style="font-size:0.8rem; opacity:0.7;">æ­£åœ¨è®€å–é¡Œåº«...</div>
        </div>
        
        <div id="cat-container" style="width:100%; flex:1;"></div>

        <button id="start-btn" class="main-btn" onclick="requestPermission()" disabled>è«‹å…ˆé¸æ“‡é¡åˆ¥</button>
        <button onclick="openModal()" style="font-size:0.8rem; background:none; border:none; color:#aaa; margin-top:10px;">âš™ï¸ è¨­å®š / è‡ªè¨‚</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <button onclick="exitGame()" style="font-size:1.5rem; background:none; border:none; color:white;">âŒ</button>
            <div id="team-label" style="background:var(--accent); padding:4px 15px; border-radius:15px; font-weight:bold; display:none;">éšŠä¼ 1</div>
            <div id="game-timer" style="font-size:1.6rem; font-weight:bold;">60s</div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%; position:relative;">
            <div id="word-cat-hint" style="color:var(--accent); font-weight:bold; margin-bottom:10px; font-size:1.2rem;"></div>
            <div id="word-display">READY</div>
            
            <div class="hint-bar">
                <span>ğŸ”„ è¢å¹•å‘ä¸‹ = æ­£ç¢º âœ…</span>
                <span>ğŸ”„ è¢å¹•å‘ä¸Š = Skip âŒ</span>
            </div>
        </div>

        <div style="width:100%; display:flex; gap:15px; padding-bottom:10px;">
            <button onclick="handleAnswer(false)" style="flex:1; padding:20px; border-radius:15px; border:none; background:var(--fail); color:white; font-weight:bold; font-size:1.2rem;">PASS</button>
            <button onclick="handleAnswer(true)" style="flex:1; padding:20px; border-radius:15px; border:none; background:var(--success); color:white; font-weight:bold; font-size:1.2rem;">æ­£ç¢º</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div id="rank-title"></div>
        <div id="final-score" style="font-size:5rem; font-weight:900; color:var(--accent); line-height:1;">0</div>
        <div style="margin:5px 0 15px 0; font-size:0.8rem; opacity:0.6;">(é»æ“Šé¡Œç›®å¯æ‰‹å‹•æ”¹åˆ†)</div>
        <div id="result-list-container" style="width:100%; max-width:500px; background:rgba(0,0,0,0.2); border-radius:15px; flex:1; overflow-y:auto; padding:5px;"></div>
        <button id="next-team-btn" class="main-btn" onclick="nextRound()" style="display:none; background:var(--success);">ä¸‹ä¸€éšŠé–‹å§‹</button>
        <button onclick="resetGame()" class="main-btn" style="background:white; color:#333;">è¿”å›ä¸»é </button>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/1xaPXAnYrABkXFDm7JQ_NIfvQkwT7n7WLSKnQAS39o8Q/export?format=csv&gid=0';
        
        let allData = {};
        let battleMode = 0;
        let isSoundOn = true;
        let currentTeamIdx = 0;
        let teamScores = [0, 0, 0];
        let gamePool = [];
        let currentWordIdx = 0;
        let gameResults = []; // {word, correct}
        let timer = null;
        let isGameActive = false;
        let lastActionTime = 0;

        // --- 1. å¼·åŒ–è®€å–é‚è¼¯ (æµè¿”è‡ªè¨‚) ---
        async function loadData() {
            document.getElementById('loader-box').style.display = 'block';
            document.getElementById('cat-container').innerHTML = '';
            
            try {
                const res = await fetch(CSV_URL + '&t=' + Date.now());
                const text = await res.text();
                
                Papa.parse(text, {
                    header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                    complete: (results) => {
                        allData = {};
                        
                        results.data.forEach(row => {
                            // å¯¬å®¹è™•ç† Categoryï¼šå¦‚æœæœ‰å¡«å°±ç”¨ï¼Œç„¡å¡«ä½†æœ‰å…§å®¹å°±ç•¶ "è‡ªè¨‚/å…¶ä»–"
                            let cat = row.Category ? row.Category.trim() : "";
                            const theme = row.Theme || "ä¸»é¡Œ";
                            const wordsRaw = row.Words;
                            
                            if (wordsRaw) {
                                if (!cat) cat = "ğŸ§© è‡ªè¨‚ / å…¶ä»–"; // æ•æ‰æ¼ç¶²ä¹‹é­š
                                const words = wordsRaw.split(/[|ï¼Œ,]+/).map(s=>s.trim()).filter(s=>s);
                                if (words.length > 0) {
                                    if(!allData[cat]) allData[cat] = [];
                                    allData[cat].push({ theme, words });
                                }
                            }
                        });

                        document.getElementById('loader-box').style.display = 'none';
                        renderUI();
                    }
                });
            } catch (e) { alert("ç¶²çµ¡éŒ¯èª¤ï¼Œç„¡æ³•è®€å–é¡Œåº«"); }
        }

        function renderUI() {
            const container = document.getElementById('cat-container');
            container.innerHTML = '';
            
            // å°‡ "è‡ªè¨‚" é¡åˆ¥æ’åœ¨æœ€å‰
            const sortedKeys = Object.keys(allData).sort((a,b) => {
                if(a.includes("è‡ªè¨‚")) return -1;
                if(b.includes("è‡ªè¨‚")) return 1;
                return 0;
            });

            sortedKeys.forEach(cat => {
                const group = document.createElement('div');
                group.className = 'cat-group';
                group.innerHTML = `<div class="group-header">${cat.includes("è‡ªè¨‚") ? 'â˜… ' : 'ğŸ“‚ '}${cat}</div>`;
                const grid = document.createElement('div');
                grid.className = 'cat-grid';
                
                allData[cat].forEach(item => {
                    const btn = document.createElement('div');
                    btn.className = 'cat-item';
                    btn.innerText = item.theme;
                    btn.dataset.words = JSON.stringify(item.words); // ç›´æ¥å­˜ data æ–¹ä¾¿è®€å–
                    btn.dataset.theme = item.theme;
                    btn.onclick = () => { 
                        btn.classList.toggle('selected'); 
                        updateStartBtn(); 
                    };
                    grid.appendChild(btn);
                });
                group.appendChild(grid);
                container.appendChild(group);
            });
        }

        function updateStartBtn() {
            const selected = document.querySelectorAll('.cat-item.selected');
            let total = 0;
            selected.forEach(el => total += JSON.parse(el.dataset.words).length);
            const btn = document.getElementById('start-btn');
            btn.disabled = total === 0;
            btn.innerText = total > 0 ? `ğŸ”¥ é–‹å§‹ (${total}è©)` : "è«‹å…ˆé¸æ“‡é¡åˆ¥";
            btn.style.background = total > 0 ? "var(--accent)" : "#7f8c8d";
        }

        // --- 2. è¦–è¦ºç‰¹æ•ˆ ---
        function triggerFeedback(isCorrect) {
            const overlay = document.getElementById('feedback-overlay');
            overlay.className = ''; // reset
            void overlay.offsetWidth; // trigger reflow
            
            if (isCorrect) {
                overlay.innerText = "âœ…";
                overlay.className = 'flash-green';
            } else {
                overlay.innerText = "âŒ";
                overlay.className = 'flash-red';
            }
        }

        // --- 3. éŠæˆ²èˆ‡ Motion Logic ---
        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(res => { if(res==='granted') setupGame(); });
            } else { setupGame(); }
        }

        function setupGame() {
            gamePool = [];
            document.querySelectorAll('.cat-item.selected').forEach(el => {
                const words = JSON.parse(el.dataset.words);
                words.forEach(w => gamePool.push({ word: w, theme: el.dataset.theme }));
            });
            gamePool.sort(() => Math.random() - 0.5);
            currentTeamIdx = 0; teamScores = [0,0,0];
            startRound();
        }

        function startRound() {
            gameResults = []; currentWordIdx = 0; isGameActive = true;
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            const tl = document.getElementById('team-label');
            if(battleMode > 0) {
                tl.style.display = 'block'; tl.innerText = `éšŠä¼ ${currentTeamIdx + 1}`;
                tl.style.backgroundColor = ['#e74c3c', '#3498db', '#f1c40f'][currentTeamIdx];
            } else { tl.style.display = 'none'; }

            let timeLeft = parseInt(document.getElementById('time-val').innerText);
            document.getElementById('game-timer').innerText = timeLeft + "s";
            
            if(timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft + "s";
                if(timeLeft <= 0) finishRound();
            }, 1000);

            window.addEventListener('deviceorientation', handleMotion);
            nextWord();
        }

        function nextWord() {
            if(currentWordIdx >= gamePool.length) { finishRound(); return; }
            const data = gamePool[currentWordIdx];
            document.getElementById('word-display').innerText = data.word;
            document.getElementById('word-cat-hint').innerText = data.theme;
        }

        function handleMotion(e) {
            if(!isGameActive || Date.now() - lastActionTime < 1000) return; // 1ç§’å†·å»
            
            // Logic å†æ¬¡ç¢ºèªï¼š
            // Beta > 60: æ‰‹æ©Ÿé ‚éƒ¨å‘å‰å‚¾ (è¢å¹•é¢å‘åœ°) -> é»é ­ -> æ­£ç¢º
            // Beta < -30: æ‰‹æ©Ÿé ‚éƒ¨å‘å¾Œä»° (è¢å¹•é¢å‘å¤©) -> æŠ¬é ­ -> Pass
            
            if(e.beta > 60) handleAnswer(true);
            else if(e.beta < -30) handleAnswer(false);
        }

        function handleAnswer(correct) {
            if(!isGameActive) return;
            lastActionTime = Date.now();
            
            gameResults.push({ word: gamePool[currentWordIdx].word, correct });
            
            // è§¸ç™¼è¦–è¦ºç‰¹æ•ˆ
            triggerFeedback(correct);
            
            setTimeout(() => {
                currentWordIdx++; nextWord();
            }, 600); // å»¶é•·å°‘å°‘æ™‚é–“æ¯”äººç‡åˆ°å€‹ç‰¹æ•ˆ
        }

        function finishRound() {
            isGameActive = false;
            clearInterval(timer);
            window.removeEventListener('deviceorientation', handleMotion);
            const score = gameResults.filter(r => r.correct).length;
            teamScores[currentTeamIdx] = score;
            showResults(score);
        }

        function showResults(score) {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            document.getElementById('final-score').innerText = score;
            
            const pct = gameResults.length > 0 ? (score / gameResults.length) * 100 : 0;
            let title = "æ°£æ°›ç ´å£è€… ğŸ¥¶";
            if (isSoundOn ? pct >= 85 : pct >= 70) title = "æ´¾å°ä¹‹ç¥ ğŸ‘‘";
            else if (isSoundOn ? pct >= 40 : pct >= 30) title = "æ™®é€šå¸‚æ°‘ ğŸ˜";
            
            document.getElementById('rank-title').innerText = title;
            if (title.includes("ç¥")) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            renderResultList();
            
            const nextBtn = document.getElementById('next-team-btn');
            nextBtn.style.display = (battleMode > 0 && currentTeamIdx < battleMode - 1) ? 'block' : 'none';
        }

        function renderResultList() {
            const list = document.getElementById('result-list-container');
            list.innerHTML = gameResults.map((r, i) => `
                <div class="result-item" onclick="toggleResult(${i})">
                    <span>${r.word}</span>
                    <span style="color:${r.correct?'var(--success)':'var(--fail)'}; font-weight:bold;">
                        ${r.correct?'âœ… æ­£ç¢º':'Pass'}
                    </span>
                </div>
            `).join('');
        }

        function toggleResult(idx) {
            gameResults[idx].correct = !gameResults[idx].correct;
            const newScore = gameResults.filter(r => r.correct).length;
            teamScores[currentTeamIdx] = newScore;
            document.getElementById('final-score').innerText = newScore;
            renderResultList();
        }

        // Settings Helpers
        function openModal() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function forceSync() { loadData(); closeModal(); }
        function cycleBattle() {
            battleMode = (battleMode === 0) ? 2 : (battleMode === 2 ? 3 : 0);
            document.getElementById('battle-btn').innerText = battleMode === 0 ? "OFF" : (battleMode + " éšŠ");
            document.getElementById('battle-btn').style.background = battleMode > 0 ? "var(--success)" : "#555";
        }
        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-btn');
            btn.innerText = isSoundOn ? "ON" : "OFF";
            btn.style.background = isSoundOn ? "var(--success)" : "#555";
        }
        function nextRound() { currentTeamIdx++; startRound(); }
        function exitGame() { if(confirm("ç¢ºå®šçµæŸéŠæˆ²ï¼Ÿ")) location.reload(); }
        function resetGame() { location.reload(); }

        loadData();
    </script>
</body>
</html>
